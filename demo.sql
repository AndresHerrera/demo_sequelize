-- creacion tabla
CREATE TABLE testfences (
  id SERIAL PRIMARY KEY,
  name VARCHAR(30),
  geom Geometry(MultiPolygon, 4326)
);

-- insertar polygonos geocercas
BEGIN;
INSERT INTO testfences ("geom" , "id", "name") VALUES ('0106000020E61000000100000001030000000100000008000000FAB2DD756EFF0040D2649F71B8A74440348E3B5D6114014012D8B4A8BCA6444011B76469F6210140A8F51111FFA644409CC23332032D014023D5107E82A7444092A1358438360140727E99E417A844405D87B999E7290140C9C14FAC5BA844403141364ACA1901404E177C5677A84440FAB2DD756EFF0040D2649F71B8A74440', 1, 'poly1');
INSERT INTO testfences ("geom" , "id", "name") VALUES ('0106000020E610000001000000010300000001000000070000006B5682A6C23501409A25B55F5AA74440B7ECE861AE360140CC4F878FE0A74440CFC9987EC2450140358AE8DE7CA84440A8A5BC77C0580140767288705EA844404C2D7611685801400DFDE16C77A74440D8D77F8EFB480140191651A333A744406B5682A6C23501409A25B55F5AA74440', 2, 'poly2');
INSERT INTO testfences ("geom" , "id", "name") VALUES ('0106000020E61000000100000001030000000100000006000000AAF6487E5F170140B43F2CFABDA7444082987E025823014042E3FDE805A84440861F728AF4240140212AB882C3A74440C0990A266E1F0140CBE93E3956A744403141364ACA190140FFAC03245DA74440AAF6487E5F170140B43F2CFABDA74440', 3, 'poly3');
COMMIT;



--QUERYS 

SELECT "id", "name", "geom" FROM "testfences" AS "testfences" WHERE ST_Intersects("geom", ST_SetSRID(ST_MakePoint('2.13976', '41.31002'), 4326)) = true;

-- Identifica si esta contenido en otro polygono 
SELECT p1."id", p1."name", ST_AsGeoJSON(p1."geom") as geom, ST_Contains(p2."geom", p1."geom") AS is_contained
FROM "testfences" AS p1
LEFT JOIN "testfences" AS p2 ON ST_Contains(p2."geom", p1."geom") AND p1."id" <> p2."id";


-- Identifica todos los poligonos, identifica el id padre y la geometria

SELECT p1."id" AS "contained_id", ST_AsGeoJSON(p1."geom") AS "contained_geom",  p1."name" as "contained_name",
       p2."id" AS "container_id", ST_AsGeoJSON(p2."geom") AS "container_geom",  p2."name" as "container_name"
FROM "testfences" AS p1
LEFT JOIN "testfences" AS p2 ON ST_Contains(p2."geom", p1."geom") AND p1."id" <> p2."id";